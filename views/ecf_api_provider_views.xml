<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista List para Proveedores de API -->
    <record id="ecf_api_provider_view_list" model="ir.ui.view">
        <field name="name">ecf.api.provider.list</field>
        <field name="model">ecf.api.provider</field>
        <field name="arch" type="xml">
            <list string="Proveedores de API">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="provider_type"/>
                <field name="environment"/>
                <field name="api_url"/>
                <field name="is_default"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <!-- Vista Form para Proveedores de API -->
    <record id="ecf_api_provider_view_form" model="ir.ui.view">
        <field name="name">ecf.api.provider.form</field>
        <field name="model">ecf.api.provider</field>
        <field name="arch" type="xml">
            <form string="Proveedor de API e-CF">
                <header>
                    <button name="action_test_connection"
                            string="Probar Conexión"
                            type="object"
                            class="btn-secondary"
                            icon="fa-plug"/>
                    <button name="action_set_as_default"
                            string="Usar por Defecto"
                            type="object"
                            class="btn-primary"
                            invisible="is_default"
                            icon="fa-star"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object"
                                class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button"
                                   options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Por Defecto"
                            bg_color="text-bg-success"
                            invisible="not is_default"/>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Nombre del Proveedor"/>
                        </h1>
                    </div>

                    <group>
                        <group string="Configuración General">
                            <field name="provider_type"/>
                            <field name="sequence"/>
                            <field name="is_default"/>
                        </group>
                        <group string="Conexión">
                            <field name="api_url"
                                   placeholder="https://api.ejemplo.com/api/invoice/send"
                                   invisible="provider_type == 'mseller'"/>
                            <field name="api_url_summary"
                                   placeholder="https://api.ejemplo.com/api/invoice/send-summary-with-ecf"
                                   invisible="provider_type == 'mseller'"
                                   help="Para facturas de consumo (tipo 32) con monto menor a 250,000. Devuelve signedEcfXml y signedRfceXml."/>
                            <field name="api_url_acecf"
                                   placeholder="https://api.ejemplo.com/api/invoice/acecf"
                                   invisible="provider_type == 'mseller'"
                                   help="Endpoint para enviar Aprobaciones Comerciales e-CF (ACECF)."/>
                            <field name="api_url"
                                   placeholder="https://ecf.api.mseller.app"
                                   invisible="provider_type != 'mseller'"/>
                            <field name="environment" invisible="provider_type == 'mseller'"/>
                            <field name="mseller_env" invisible="provider_type != 'mseller'"/>
                            <field name="timeout"/>
                        </group>
                    </group>

                    <notebook>
                        <!-- Pestaña de Autenticación -->
                        <page string="Autenticación" name="auth">
                            <group>
                                <group string="Tipo de Autenticación">
                                    <field name="auth_type"/>
                                </group>
                                <group string="Credenciales"
                                       invisible="auth_type == 'none'">
                                    <!-- Bearer Token -->
                                    <field name="auth_token"
                                           string="Bearer Token"
                                           password="True"
                                           invisible="auth_type != 'bearer'"/>

                                    <!-- API Key -->
                                    <field name="api_key_header"
                                           invisible="auth_type not in ('api_key', 'mseller')"/>
                                    <field name="auth_token"
                                           string="API Key"
                                           password="True"
                                           invisible="auth_type not in ('api_key', 'mseller')"/>

                                    <!-- Basic Auth -->
                                    <field name="auth_username"
                                           string="Usuario"
                                           invisible="auth_type != 'basic'"/>
                                    <field name="auth_password"
                                           string="Contraseña"
                                           password="True"
                                           invisible="auth_type != 'basic'"/>

                                    <!-- MSeller -->
                                    <field name="auth_username"
                                           string="Email MSeller"
                                           invisible="auth_type != 'mseller'"/>
                                    <field name="auth_password"
                                           string="Password MSeller"
                                           password="True"
                                           invisible="auth_type != 'mseller'"/>
                                </group>
                            </group>
                        </page>

                        <!-- Pestaña de Formato de Payload (solo para Local/Custom) -->
                        <page string="Formato de Payload" name="payload"
                              invisible="provider_type == 'mseller'">
                            <group>
                                <group string="Formato">
                                    <field name="payload_format"/>
                                </group>
                                <group string="Opciones de Wrapper"
                                       invisible="payload_format != 'wrapped'">
                                    <field name="wrapper_field"
                                           placeholder="invoiceData"/>
                                    <field name="include_rnc"/>
                                    <field name="include_encf"/>
                                    <field name="include_environment"/>
                                </group>
                            </group>
                            <group string="Ejemplo de Payload" invisible="payload_format != 'wrapped'">
                                <div class="alert alert-info" role="alert">
                                    <p><strong>El payload se enviará con esta estructura:</strong></p>
                                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px;">{
  "<field name="wrapper_field" readonly="1"/>": {
    "ECF": { ... }
  },
  "rnc": "130939616",  // Si "Incluir RNC" está activo
  "encf": "E310000000034",  // Si "Incluir eNCF" está activo
  "environment": "cert"  // Si "Incluir Ambiente" está activo
}</pre>
                                </div>
                            </group>
                        </page>

                        <!-- Pestaña de Mapeo de Respuesta -->
                        <page string="Mapeo de Respuesta" name="response">
                            <group>
                                <group string="Campos de Respuesta">
                                    <field name="response_track_id_field"
                                           placeholder="trackId"/>
                                    <field name="response_status_field"
                                           placeholder="status"/>
                                    <field name="response_message_field"
                                           placeholder="message"/>
                                </group>
                            </group>
                            <group string="Información">
                                <div class="text-muted">
                                    <p>Configure cómo extraer datos de la respuesta de la API:</p>
                                    <ul>
                                        <li><strong>Track ID:</strong> Identificador único del documento procesado</li>
                                        <li><strong>Estado:</strong> Campo que indica si fue aceptado/rechazado</li>
                                        <li><strong>Mensaje:</strong> Mensaje de respuesta o error</li>
                                    </ul>
                                    <p>La búsqueda es case-insensitive y también busca en sub-objetos como "data", "result", etc.</p>
                                </div>
                            </group>
                        </page>

                        <!-- Pestaña de Notas -->
                        <page string="Notas" name="notes">
                            <field name="notes" placeholder="Notas o documentación sobre este proveedor..."/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Acción para abrir Proveedores de API -->
    <record id="ecf_api_provider_action" model="ir.actions.act_window">
        <field name="name">Proveedores de API</field>
        <field name="res_model">ecf.api.provider</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Configure sus proveedores de API para envío de e-CF
            </p>
            <p>
                Puede configurar múltiples APIs como MSeller, una API local, o APIs personalizadas.
                El proveedor marcado como "Por Defecto" será usado automáticamente para los envíos.
            </p>
        </field>
    </record>

    <!-- Menú para Proveedores de API -->
    <menuitem id="menu_ecf_api_provider"
              name="Proveedores de API"
              parent="menu_e_cf_root"
              action="ecf_api_provider_action"
              sequence="3"/>

</odoo>
