<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================== -->
    <!-- DGII Callback Request Views -->
    <!-- ================================================================== -->

    <!-- List View -->
    <record id="dgii_callback_request_view_list" model="ir.ui.view">
        <field name="name">dgii.callback.request.view.list</field>
        <field name="model">dgii.callback.request</field>
        <field name="arch" type="xml">
            <list string="Callbacks DGII" decoration-danger="state == 'error'" decoration-warning="state == 'duplicate'" decoration-success="state == 'processed'" decoration-info="state == 'queued' or state == 'processing'">
                <field name="name"/>
                <field name="callback_type"/>
                <field name="encf"/>
                <field name="rnc_emisor"/>
                <field name="track_id"/>
                <field name="remote_ip"/>
                <field name="received_at"/>
                <field name="state" widget="badge" decoration-success="state == 'processed'" decoration-danger="state == 'error'" decoration-warning="state == 'duplicate'" decoration-info="state in ('queued', 'processing')"/>
                <field name="processing_time_ms" optional="hide"/>
                <field name="company_id" groups="base.group_multi_company" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="dgii_callback_request_view_form" model="ir.ui.view">
        <field name="name">dgii.callback.request.view.form</field>
        <field name="model">dgii.callback.request</field>
        <field name="arch" type="xml">
            <form string="Callback DGII">
                <header>
                    <button name="action_reprocess" type="object" string="Reprocesar" class="oe_highlight" invisible="state not in ('error', 'received')"/>
                    <button name="action_mark_duplicate" type="object" string="Marcar como Duplicado" invisible="state == 'duplicate'"/>
                    <button name="action_view_inbox" type="object" string="Ver Inbox" class="btn-secondary" invisible="not ecf_inbox_id"/>
                    <field name="state" widget="statusbar" statusbar_visible="received,queued,processing,processed"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_download_body" type="object" class="oe_stat_button" icon="fa-download" invisible="not request_body_raw">
                            <span>Descargar Body</span>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Identificación">
                            <field name="callback_type"/>
                            <field name="idempotency_key"/>
                            <field name="original_request_id" invisible="state != 'duplicate'"/>
                            <field name="duplicate_count" invisible="duplicate_count == 0"/>
                        </group>
                        <group string="Datos Extraídos">
                            <field name="encf"/>
                            <field name="rnc_emisor"/>
                            <field name="rnc_receptor"/>
                            <field name="track_id"/>
                            <field name="fecha_emision"/>
                            <field name="monto_total"/>
                        </group>
                    </group>
                    <group invisible="callback_type != 'aprobacion_comercial'">
                        <group string="Aprobación Comercial">
                            <field name="estado_aprobacion"/>
                            <field name="motivo_rechazo" invisible="estado_aprobacion != 'rechazado'"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Request HTTP" name="request">
                            <group>
                                <group>
                                    <field name="request_method"/>
                                    <field name="request_path"/>
                                    <field name="content_type"/>
                                    <field name="content_length"/>
                                </group>
                                <group>
                                    <field name="remote_ip"/>
                                    <field name="user_agent"/>
                                    <field name="received_at"/>
                                </group>
                            </group>
                            <group string="Headers">
                                <field name="request_headers_display" nolabel="1" widget="ace" options="{'mode': 'json'}"/>
                            </group>
                            <group string="Body">
                                <field name="request_body_display" nolabel="1" widget="ace" options="{'mode': 'xml'}"/>
                            </group>
                        </page>
                        <page string="Respuesta" name="response">
                            <group>
                                <group>
                                    <field name="response_status_code"/>
                                    <field name="response_sent_at"/>
                                    <field name="processing_time_ms"/>
                                </group>
                                <group>
                                    <field name="job_uuid"/>
                                    <field name="processed_at"/>
                                </group>
                            </group>
                            <group string="Body Respuesta">
                                <field name="response_body" nolabel="1" widget="ace" options="{'mode': 'xml'}"/>
                            </group>
                        </page>
                        <page string="Errores" name="errors" invisible="state != 'error'">
                            <group>
                                <field name="error_count"/>
                                <field name="error_message" readonly="1"/>
                            </group>
                        </page>
                        <page string="Relaciones" name="relations">
                            <group>
                                <field name="ecf_inbox_id" string="ID Documento Inbox"/>
                                <field name="test_case_id"/>
                                <field name="company_id" groups="base.group_multi_company"/>
                            </group>
                        </page>
                        <page string="Body Raw" name="raw">
                            <field name="request_body_raw" readonly="1"/>
                            <field name="request_headers_raw" readonly="1" invisible="1"/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Search View -->
    <record id="dgii_callback_request_view_search" model="ir.ui.view">
        <field name="name">dgii.callback.request.view.search</field>
        <field name="model">dgii.callback.request</field>
        <field name="arch" type="xml">
            <search string="Buscar Callbacks">
                <field name="name"/>
                <field name="encf"/>
                <field name="rnc_emisor"/>
                <field name="track_id"/>
                <field name="remote_ip"/>
                <separator/>
                <filter string="Recepción" name="filter_recepcion" domain="[('callback_type', '=', 'recepcion')]"/>
                <filter string="Aprobación" name="filter_aprobacion" domain="[('callback_type', '=', 'aprobacion_comercial')]"/>
                <filter string="Autenticación" name="filter_auth" domain="[('callback_type', 'in', ['autenticacion_semilla', 'autenticacion_validacion'])]"/>
                <separator/>
                <filter string="Pendientes" name="filter_pending" domain="[('state', 'in', ['received', 'queued'])]"/>
                <filter string="Procesados" name="filter_processed" domain="[('state', '=', 'processed')]"/>
                <filter string="Errores" name="filter_errors" domain="[('state', '=', 'error')]"/>
                <filter string="Duplicados" name="filter_duplicates" domain="[('state', '=', 'duplicate')]"/>
                <separator/>
                <filter string="Tipo" name="groupby_type" context="{'group_by': 'callback_type'}"/>
                <filter string="Estado" name="groupby_state" context="{'group_by': 'state'}"/>
                <filter string="IP" name="groupby_ip" context="{'group_by': 'remote_ip'}"/>
                <filter string="Fecha" name="groupby_date" context="{'group_by': 'received_at:day'}"/>
            </search>
        </field>
    </record>

    <!-- Kanban View -->
    <record id="dgii_callback_request_view_kanban" model="ir.ui.view">
        <field name="name">dgii.callback.request.view.kanban</field>
        <field name="model">dgii.callback.request</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="state">
                <field name="name"/>
                <field name="callback_type"/>
                <field name="encf"/>
                <field name="state"/>
                <field name="received_at"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <span class="badge rounded-pill" t-attf-class="#{record.state.raw_value == 'processed' ? 'text-bg-success' : record.state.raw_value == 'error' ? 'text-bg-danger' : 'text-bg-secondary'}">
                                    <field name="state"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="callback_type"/>
                                <br/>
                                <span t-if="record.encf.raw_value">
                                    e-NCF: <field name="encf"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="received_at" widget="date"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Graph View -->
    <record id="dgii_callback_request_view_graph" model="ir.ui.view">
        <field name="name">dgii.callback.request.view.graph</field>
        <field name="model">dgii.callback.request</field>
        <field name="arch" type="xml">
            <graph string="Callbacks DGII" type="bar">
                <field name="received_at" interval="day"/>
                <field name="callback_type" type="row"/>
                <field name="id" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Pivot View -->
    <record id="dgii_callback_request_view_pivot" model="ir.ui.view">
        <field name="name">dgii.callback.request.view.pivot</field>
        <field name="model">dgii.callback.request</field>
        <field name="arch" type="xml">
            <pivot string="Callbacks DGII">
                <field name="received_at" interval="day" type="col"/>
                <field name="callback_type" type="row"/>
                <field name="state" type="row"/>
                <field name="id" type="measure"/>
                <field name="processing_time_ms" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Action -->
    <record id="action_dgii_callback_request" model="ir.actions.act_window">
        <field name="name">Callbacks DGII</field>
        <field name="res_model">dgii.callback.request</field>
        <field name="view_mode">list,kanban,form,graph,pivot</field>
        <field name="search_view_id" ref="dgii_callback_request_view_search"/>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay callbacks DGII registrados
            </p>
            <p>
                Los callbacks se registran automáticamente cuando la DGII o proveedores
                envían notificaciones a los endpoints configurados.
            </p>
            <p>
                Endpoints disponibles:
                <ul>
                    <li><code>POST /fe/recepcion/api/ecf</code> - Recepción de e-CF</li>
                    <li><code>POST /fe/aprobacioncomercial/api/ecf</code> - Aprobación comercial</li>
                    <li><code>GET /fe/autenticacion/api/semilla</code> - Obtener semilla</li>
                    <li><code>POST /fe/autenticacion/api/validacioncertificado</code> - Validar certificado</li>
                </ul>
            </p>
        </field>
    </record>

    <!-- Action for errors only -->
    <record id="action_dgii_callback_request_errors" model="ir.actions.act_window">
        <field name="name">Callbacks con Errores</field>
        <field name="res_model">dgii.callback.request</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('state', '=', 'error')]</field>
        <field name="context">{'search_default_filter_errors': 1}</field>
    </record>

    <!-- Menu Items (se agregan al menú existente) -->
    <menuitem
        id="menu_dgii_callbacks"
        name="Callbacks DGII"
        parent="l10n_do_e_cf_tests.menu_e_cf_root"
        sequence="50"/>

    <menuitem
        id="menu_dgii_callback_request"
        name="Callbacks Recibidos"
        parent="menu_dgii_callbacks"
        action="action_dgii_callback_request"
        sequence="10"/>

    <menuitem
        id="menu_dgii_callback_request_errors"
        name="Callbacks con Errores"
        parent="menu_dgii_callbacks"
        action="action_dgii_callback_request_errors"
        sequence="20"/>

</odoo>
